{% extends "allergyworld/base.html" %}
{% load staticfiles %}
{% load bootstrap_pagination %}
<!-- search.html -->
{% block title %}
Search Results
{% endblock %}

{% block mapjs %}

<!--script for dynamic google map for restaurant locations -->
<script>
  function initialize() {
    var myLatLng = new google.maps.LatLng({{ usrlat }}, {{ usrlng }})
  
    var mapOptions = {
      zoom: 14,
      center: myLatLng
    };

    var map = new google.maps.Map(document.getElementById('map-canvas'),
        mapOptions);
    
    var userMarker = new google.maps.Marker({
      position: myLatLng,
      map: map,
      animation: google.maps.Animation.DROP,
      icon: "{% static 'allergyworld/img/blue_MarkerU.png' %}"
    });
    //user infobox
    var usrContentString = '<div id="content">'+
      '<div id="bodyContent">'+
      '<strong>You are here.</strong>'+
      '</div>'+
      '</div>';
    var usrInfobox = new google.maps.InfoWindow({
      content: usrContentString
    });
    google.maps.event.addListener(userMarker, 'click', function() {
      usrInfobox.open(map,userMarker);
    });

    //restaurant markers
    {% if results %}
    {% for result,dist in results %}
    var latLng{{ result.id }} = new google.maps.LatLng({{ result.lat }}, {{ result.lng }})
    var marker{{ result.id }} = new google.maps.Marker({
      position: latLng{{ result.id }},
      map: map
    })
    var contentString{{ result.id }} = '<div id="content">'+
      '<div id="bodyContent">'+
      '<strong>'+"{{ result.name }}"+'</strong>'+
      '</div>'+
      '</div>';
    var resultInfobox{{ result.id }} = new google.maps.InfoWindow({
      content: contentString{{ result.id }}
    });
    var boxOpen{{ result.id }} = false;
    google.maps.event.addDomListener(document.getElementById("panel-heading-{{ result.id }}"), 'click', function() {
      if (boxOpen{{ result.id }} == false) {
        resultInfobox{{ result.id }}.open(map,marker{{ result.id }});
        boxOpen{{ result.id }} = true;
      } else {
        resultInfobox{{ result.id }}.close();
        boxOpen{{ result.id }} = false;
      }
      
    });
    {% endfor %}
    {% endif %}
  }

  function loadScript() {
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = 'https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&' +
        'callback=initialize&key=AIzaSyAmtzKMmQcC0mcXxvuUDcXYpocqMZiBAFg';
    document.body.appendChild(script);
  }

  window.onload = loadScript;
</script>

{% endblock %}

{% block body %}
<!-- search bar -->
<div class="container">
  <div class="row clearfix">
    <div class="col-md-12 column">
      <br/><br/>

      <center>
          <form role="form" class="form-inline" action='/allergyworld/search/' method='get'>
            <div class="form-group" >
               <input list="allergies" class="form-control" name="allergy" placeholder="Allergy"/>
                <datalist id="allergies">
                  <option value="Peanut">
                  <option value="Tree nuts">
                  <option value="Milk">
                  <option value="Egg">
                  <option value="Wheat">
                  <option value="Soy">
                  <option value="Fish">
                  <option value="Shellfish">
                </datalist>
            </div>
            <div class="form-group" >
               <input type="text" class="form-control" name="location" required placeholder="Location" />
            </div>
            <div class="form-group" >
               <input list="cuisines" class="form-control" name="cuisine" placeholder="Cuisine" />
                <datalist id="cuisines">
            <option value="American">
            <option value="Chinese">
            <option value="Indian">
            <option value="Italian">
            <option value="Mexican">
          </datalist>
            </div>
            <div class="form-group">
             <button type="submit" class="btn btn-default" style="background-color:rgb(144,202,79)">
              <span class="glyphicon glyphicon-search"></span> Search</button>
           </div>
          </form>
        </center>
      
    </div>
  </div>
  <hr/>
  {% block results %}
  <div class="row clearfix">
    <!-- div for holding results list -->
    <div class="col-md-6 column">
      <div class="row clearfix">
        
        <div class="col-md-8 column">
          <h3>
            You searched for <strong>{{ query }}</strong>
          </h3>
        </div>
        
      </div>
      {% if results %}
          
      <div class="row clearfix">
          <div class="col-md-6 column">
            <p>Found {{ total_num }} restaurant{{ results|pluralize }}.</p>
          </div>
      </div>
      <!-- panel -->
      <div class="row clearfix">
        <div class="col-md-10 column">
          <div class="panel-group" id="panel-results">
          {% for result,dist in results %}
        
            <div class="panel panel-default">
              <div class="panel-heading">
                 <a id="panel-heading-{{ result.id }}" class="panel-title collapsed" data-toggle="collapse" data-parent="#panel-results" href="#panel-element-{{ result.id }}" >{{ result.name }}</a>
              </div>
              <div id="panel-element-{{ result.id }}" class="panel-collapse collapse">
                <div class="panel-body">
                  Google+ Ratings: {{ result.rating }}</br>
                  <address>{{ result.address }}</address>
                  <a href={{ result.website }}>Website</a>
                </div>
              </div>
            </div>
        
          {% endfor %}
          </div>
        </div>
      </div>
        
      {% else %}
        <div class="row clearfix">
          <div class="col-md-8 column">
            <p>Sorry, no restaurants matched your search criteria.</p>
          </div>
        </div>
        
      {% endif %}
      
      <div class="row clearfix">
        <div class="col-md-8 column">
          {% bootstrap_paginate results %}
        </div>
      </div>
    </div>

    <!-- div for holding google map for results -->
    <div class="col-md-6 column">
      <br/>
      <div class="col-md-12 column" id="map-canvas" style="height:500px">
      </div>
    </div>
  </div>
  {% endblock %}

  <div class="row clearfix">
    <div class="col-md-12 column">
    </div>
  </div>
</div>
{% endblock %}


